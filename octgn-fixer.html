<!doctype html>
<html lang="en" data-framework="typescript">
	<head>
		<meta charset="utf-8">
		<title>AGOT OCTGN Fixer</title>
		<link href='https://fonts.googleapis.com/css?family=Cinzel' rel='stylesheet' type='text/css'>
		<link href="/css/setup-analyzer.css" media="all" rel="stylesheet">
		<link href="/css/hint.css" media="all" rel="stylesheet">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	</head>
	<body>
    <h2>Select octgn file with The King's Peace cards:</h2>
    <input type="file" id="file-input" />
	</body>
  <script>
  function readSingleFile(e) {
    var file = e.target.files[0];
    if (!file) {
      return;
    }
    var reader = new FileReader();
    reader.onload = function(e) {
      var filename = "";
      var fullPath = document.getElementById('file-input').value;
      if (fullPath) {
      	var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
      	filename = fullPath.substring(startIndex);
      	if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
      		filename = filename.substring(1);
      	}
        filename = filename.substring(0, filename.lastIndexOf('.'));
      }

      var contents = e.target.result;
      download(filename+"-fixed.o8d", fixFile(contents));
    };
    reader.readAsText(file);
  }

  function fixFile(content){
    var cards = {
      '52ec9be0-c100-4414-9c3a-070c96146f2f': 'Ser Rodrik Cassel',
      'cb5ae535-6b4b-4100-8593-1e231b3da602': 'Wolf Dreams',
      'b16db828-bdc9-4134-b37c-08cf0973ed29': 'Ser Hobber Redwyne',
      'ca9c9145-6b31-4abe-9fe6-6a118c7834a8': 'Mare in Heat',
      '3b899353-3c49-499a-9145-1703498b6a69': 'Ser Alliser Thorne',
      '6703e46a-9602-4501-88fd-c06e2816817a': 'Practice Blade',
      '47292ec9-f2dc-4786-b895-d92c2ae9af80': 'Moon Boy',
      'c9e6fcab-2b73-4a09-a5df-07426703a834': 'The King&#039;s Peace',
      '72f0baa9-2df4-432b-bc64-416dd987a95c': 'Ser Gregor Clegane',
      '7f6b25ff-02de-41ad-9f10-70d6b23996c3': 'I Never Bet Against My Family',
      'd57749cb-274c-440e-b6b1-f81a98b5cd9f': 'Newly-Made Lord',
      'f4fa304e-4fb0-4d4d-9cb8-8bb00293df69': 'Fishing Net',
      'b9356c1e-a2ac-42fc-855e-3919847a6eda': 'Crone of Vaes Dothrak',
      '5f23af51-be07-4ec4-9cd0-50dd07fd8a1a': 'The Silver Steed',
      '0c297793-b421-4f54-96b1-028622a0c1cf': 'Attainted',
      'b3cf0188-d889-4d5d-ae89-e17730685318': 'The Boneway',
      'fdf1989a-ee7d-4972-9d12-b299bfe3ba6d': 'Hedge Knight',
      'e56bf52d-27ee-445c-95f1-f0df92d26873': 'Knighted',
      '511f5ad9-0bff-4b7c-9563-0861ecf0fa99': 'A Tourney for the King',
      'f1841168-04de-4aa3-a2f0-8d3b1b8047b2': 'The Lord of the Crossing'
    };

    var results = content;
    for (var id in cards) {
      var re = new RegExp('id="">'+cards[id], 'gi');
      results = results.replace(re, 'id="' + id + '">'+cards[id]);
    }
    return results;
  }

  function displayContents(contents) {
    var element = document.getElementById('file-content');
    element.innerHTML = contents;
  }

  function download(filename, text) {
      var pom = document.createElement('a');
      pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      pom.setAttribute('download', filename);

      if (document.createEvent) {
          var event = document.createEvent('MouseEvents');
          event.initEvent('click', true, true);
          pom.dispatchEvent(event);
      }
      else {
          pom.click();
      }
  }

  document.getElementById('file-input')
    .addEventListener('change', readSingleFile, false);
  </script>
</html>

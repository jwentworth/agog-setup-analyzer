<!doctype html>
<html lang="en" data-framework="typescript">
	<head>
		<meta charset="utf-8">
		<title>AGOT OCTGN Fixer</title>
		<link href='https://fonts.googleapis.com/css?family=Cinzel' rel='stylesheet' type='text/css'>
		<link href="/css/setup-analyzer.css" media="all" rel="stylesheet">
		<link href="/css/hint.css" media="all" rel="stylesheet">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	</head>
	<body>
    <h2>Select octgn file with Calm Over Westeros cards from Thronesdb:</h2>
    <input type="file" id="file-input" />
	</body>
  <script>
  function readSingleFile(e) {
    var file = e.target.files[0];
    if (!file) {
      return;
    }
    var reader = new FileReader();
    reader.onload = function(e) {
      var filename = "";
      var fullPath = document.getElementById('file-input').value;
      if (fullPath) {
      	var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
      	filename = fullPath.substring(startIndex);
      	if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
      		filename = filename.substring(1);
      	}
        filename = filename.substring(0, filename.lastIndexOf('.'));
      }

      var contents = e.target.result;
      download(filename+"-fixed.o8d", fixFile(contents));
    };
    reader.readAsText(file);
  }

  function fixFile(content){
    var cards = {
			"f9abc810-826c-40d1-a65b-bcf828fb747b": "Famine",
			"9d81eee2-2281-4bad-933c-9915b9eb9aca": "Nightmares",
			"b36e1dba-88fe-4c14-919b-80ca08fe9e81": "The Eyrie",
			"f25460d6-2897-41ae-97ff-d433855d4294": "Street of Steel",
			"b6a02e7e-8bc7-43dd-82b3-1cdf89079fea": "Vengeance for Elia",
			"7a4d2704-9b60-4fca-bcef-9288151693db": "Knights of the Sun",
			"0bc969c3-8e91-4a9b-80bf-77ef223dbeed": "Blood Magic Ritual",
			"5807c40f-5560-44b6-a745-992eabfcfda0": "Mirri Maz Duur",
			"5ad0b950-40c8-4a29-8128-10c81eb862e0": "Iron Mines",
			"ae4178c4-d902-436c-b5d5-ea7440f9e6e8": "Raider from Pyke",
			"f2626ce8-be3d-4e63-b2a6-0b33ae5e6f60": "Trial by Combat",
			"d8f39831-ef30-4f90-a8cb-8bbc4c659c7d": "Bronn",
			"495f1553-c28b-49a7-b1d6-9cace43d9d2a": "Stinking Drunk",
			"2f2d781c-f2a9-4214-8939-0e1aaf2bae17": "Kingswood",
			"f88dd3c7-cae8-4e52-b810-8fbd8f70fd23": "Northern Rookery",
			"8b97ebcf-4cf8-48a1-91ca-45496776640b": "Chett",
			"28288527-476c-453f-8bb4-04e01ebe7cea": "Pulling the Strings",
			"b5c87361-de05-44db-8062-42cefb20b9e3": "Roseroad Patrol",
			"f79de2ff-4b49-4c6e-8a22-d49f8040010e": "Winterfell Crypt",
			"a4c8ad30-3930-4461-bde4-aa2e2f20a6c1": "Greatjonâ€™s Vanguard",
			"5183c3de-7174-4f1d-b9cd-67c47a4b7251": "Tourney Grounds",
    };

    var results = content;
    for (var id in cards) {
      var re = new RegExp('id="">'+cards[id], 'gi');
      results = results.replace(re, 'id="' + id + '">'+cards[id]);
    }
    return results;
  }

  function displayContents(contents) {
    var element = document.getElementById('file-content');
    element.innerHTML = contents;
  }

  function download(filename, text) {
      var pom = document.createElement('a');
      pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      pom.setAttribute('download', filename);

      if (document.createEvent) {
          var event = document.createEvent('MouseEvents');
          event.initEvent('click', true, true);
          pom.dispatchEvent(event);
      }
      else {
          pom.click();
      }
  }

  document.getElementById('file-input')
    .addEventListener('change', readSingleFile, false);
  </script>
</html>
